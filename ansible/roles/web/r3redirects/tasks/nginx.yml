---

- name: create webroot path
  file:
    name: "{{ r3rsrv.rootdir }}"
    state: directory
    owner: www-data

- name: Copy files to remote locations
  ansible.builtin.copy:
    dest: "{{ r3rsrv.rootdir }}/404.html"
    group: www-data
    owner: www-data
    src: files/404.html

- name: install nginx vhost config files
  template:
    src: "{{ r3rsrv.name }}.j2"
    dest: /etc/nginx/sites-available/{{ r3rsrv.name }}
  notify: reload nginx

- name: clear variable
  set_fact:
    nginx_acme_cert: {}

- name: check if acme certs already exists
  stat:
    path: "/var/lib/acme/live/{{ item }}"
  with_items: "{{ r3rsrv.urls }}"
  register: nginx_acme_cert

- name: set acmecert_missing_hostnames variable
  set_fact:
    acmecert_missing_hostnames: "{{ nginx_acme_cert.results | acme_cert_nonexistent(r3rsrv.urls) }}"

- name: link nonexistent hostnames to self-signed interim cert
  when: acmecert_missing_hostnames | length > 0
  block:
    - name: get id of existing selfsigned interim certificate
      command: cat /var/lib/acme/.selfsigned-interim-cert
      changed_when: false
      check_mode: false
      register: selfsigned_interim_cert_id

    - name: set selfsigned_interim_cert_id variable
      set_fact:
        selfsigned_interim_cert_id: "{{ selfsigned_interim_cert_id.stdout }}"

    - name: link to snakeoil cert for nonexistent hostnames
      file:
        src: "../certs/{{ selfsigned_interim_cert_id }}"
        dest: "/var/lib/acme/live/{{ item }}"
        state: link
      with_items: "{{ acmecert_missing_hostnames }}"

- name: enable vhost config using acme cert
  file:
    src: "../sites-available/{{ r3rsrv.name }}"
    dest: "/etc/nginx/sites-enabled/{{ r3rsrv.name }}"
    state: link
  notify: reload nginx

- name: make sure nginx config has been loaded
  meta: flush_handlers

- name: get certificate using acmetool
  import_role:
    name: acmetool/cert
  vars:
    acmetool_cert_name: "{{ r3rsrv.urls[0] }}"
    acmetool_cert_hostnames: "{{ r3rsrv.urls }}"
